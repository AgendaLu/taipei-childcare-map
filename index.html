<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>臺北市準公共化托嬰中心｜線上地圖</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <!-- MarkerCluster (optional but recommended for 200+ points) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <!-- PapaParse (CSV fallback) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif; }
    .wrap { display: grid; grid-template-columns: 380px 1fr; height: 100%; }
    .side { border-right: 1px solid #e5e7eb; padding: 12px; overflow: auto; background: #fff; }
    .map { height: 100%; }
    .controls { display: grid; gap: 8px; }
    .titlebar { display:flex; align-items:baseline; justify-content:space-between; gap: 10px; }
    .titlebar h1 { font-size: 16px; margin: 0; }
    .titlebar .small { font-size: 12px; color: #64748b; }
    input, select, button { padding: 10px; border-radius: 12px; border: 1px solid #cbd5e1; font-size: 14px; }
    button { cursor: pointer; background: #111827; color: white; border: 0; }
    button.secondary { background: #0f172a; }
    button.ghost { background: #fff; color: #0f172a; border: 1px solid #cbd5e1; }
    button:disabled { background: #6b7280; cursor: not-allowed; border: 0; color: #fff; }
    .hint { font-size: 12px; color: #64748b; line-height: 1.5; }
    .status { margin-top: 6px; font-size: 12px; color: #334155; }
    .chips { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
    .chip { font-size: 12px; padding: 3px 8px; border-radius: 999px; border: 1px solid #e5e7eb; color: #334155; background: #fff; }
    .row { padding: 10px; border: 1px solid #e5e7eb; border-radius: 12px; margin: 10px 0; cursor: pointer; }
    .row:hover { background: #f8fafc; }
    .row .name { font-weight: 700; font-size: 14px; }
    .row .meta { color: #475569; font-size: 12px; margin-top: 4px; line-height: 1.4; }
    .row .dist { color: #0f172a; font-weight: 600; }
    .divider { height: 1px; background: #e5e7eb; margin: 10px 0; }
    .rowbtns { display:flex; gap: 8px; }
    .rowbtns > * { flex: 1; }
    @media (max-width: 900px) {
      .wrap { grid-template-columns: 1fr; grid-template-rows: 46vh 1fr; }
      .side { border-right: 0; border-bottom: 1px solid #e5e7eb; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="side">
    <div class="titlebar">
      <h1>臺北市準公共化托嬰中心</h1>
      <div class="small">GitHub Pages</div>
    </div>

    <div class="divider"></div>

    <div class="controls">
      <input id="q" placeholder="搜尋：名稱 / 地址 / 電話" />
      <select id="district">
        <option value="">全部行政區</option>
      </select>
      <select id="evaluation">
        <option value="">全部評鑑</option>
      </select>

      <div class="rowbtns">
        <button id="locate" class="secondary">定位我（附近排序/篩選）</button>
        <button id="clearLocate" class="ghost" disabled>清除定位</button>
      </div>

      <select id="radius">
        <option value="">距離篩選：不限</option>
        <option value="0.5">0.5 公里內</option>
        <option value="1">1 公里內</option>
        <option value="2">2 公里內</option>
        <option value="5">5 公里內</option>
        <option value="10">10 公里內</option>
      </select>

      <select id="sort">
        <option value="name">排序：名稱</option>
        <option value="district">排序：行政區</option>
        <option value="distance" disabled>排序：距離（需定位）</option>
      </select>

      <button id="download">下載目前篩選結果（JSON）</button>

      <div class="hint">
        讀取資料優先順序：<code>./data.json</code>（最快）→ 兩份 CSV Join（<code>./臺北市準公共化托嬰中心.csv</code> + <code>./XY Data.csv</code>）→ <code>./data.csv</code>。<br>
        你的 <code>XY Data.csv</code> 目前看起來是「經度在 lat、緯度在 lng」；本頁會自動偵測並修正（lat&gt;90 會交換）。<br>
        建議把檔名改成英文（例如 <code>centers.csv</code>, <code>xy.csv</code>）可以避免路徑編碼問題（尤其有空白或中文時）。
      </div>
      <div id="status" class="status"></div>
    </div>

    <div class="chips" id="chips"></div>
    <div id="list"></div>
  </div>

  <div id="map" class="map"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/**
 * 建議資料格式：data.json（已合併且含座標）
 * [
 *  { "id": 1, "name": "...", "district": "...", "address": "...", "phone": "...",
 *    "approved": "...", "current": "...", "evaluation": "...", "lat": 25.0, "lon": 121.5 }
 * ]
 *
 * 若沒有 data.json，本頁會嘗試把以下兩份 CSV 依序號/ID join：
 * - 臺北市準公共化托嬰中心.csv：包含機構資訊（序號、機構名稱、行政區、地址、電話、核定/實際、評鑑）
 * - XY Data.csv：包含座標（id、Response_Address、lat、lng）
 *
 * 最後才回退到 data.csv（單一 CSV + 含座標欄位）。
 */

const DATA_URL_JSON = "./data.json";
const DATA_URL_CENTERS_CSV = "./臺北市準公共化托嬰中心.csv";
const DATA_URL_XY_CSV = "./XY Data.csv";
const DATA_URL_CSV_FALLBACK  = "./data.csv"; // optional fallback

const els = {
  q: document.getElementById("q"),
  district: document.getElementById("district"),
  evaluation: document.getElementById("evaluation"),
  radius: document.getElementById("radius"),
  sort: document.getElementById("sort"),
  locate: document.getElementById("locate"),
  clearLocate: document.getElementById("clearLocate"),
  chips: document.getElementById("chips"),
  list: document.getElementById("list"),
  status: document.getElementById("status"),
  download: document.getElementById("download"),
};

function setStatus(msg) { els.status.textContent = msg || ""; }
function escapeHtml(s) {
  return (s ?? "").toString().replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
}
function uniq(arr) { return Array.from(new Set(arr.filter(x => (x ?? "").toString().trim() !== ""))); }

function pick(obj, keys, fallback="") {
  for (const k of keys) {
    if (obj && Object.prototype.hasOwnProperty.call(obj, k)) {
      const v = obj[k];
      if (v !== undefined && v !== null && String(v).trim() !== "") return v;
    }
  }
  return fallback;
}

function toFloat(x) {
  const n = parseFloat(String(x ?? "").trim());
  return Number.isFinite(n) ? n : null;
}

function toInt(x) {
  const n = parseInt(String(x ?? "").trim(), 10);
  return Number.isFinite(n) ? n : null;
}

// 取得坐標並自動修正（如果 lat 看起來像經度）
function normalizeLatLon(latRaw, lonRaw) {
  let lat = toFloat(latRaw);
  let lon = toFloat(lonRaw);
  if (!Number.isFinite(lat) || !Number.isFinite(lon)) return { lat: null, lon: null };

  // Taiwan: lat 約 21~26，lon 約 119~123
  // 若 lat > 90 且 lon < 90，代表兩者顛倒
  if (Math.abs(lat) > 90 && Math.abs(lon) <= 90) {
    const tmp = lat; lat = lon; lon = tmp;
  }
  return { lat, lon };
}

function normalizeRecord(r) {
  // 支援：data.json / data.csv / centers csv rows
  const id = toInt(pick(r, ["id","ID","序號"], "")) ?? null;

  const name = pick(r, ["name","Name(機構名稱)","機構名稱"], "");
  const district = pick(r, ["district","District(行政區)","行政區"], "");
  const address = pick(r, ["address","Address(地址)","地址","Response_Address"], "");
  const phone = pick(r, ["phone","Phone(電話)","電話"], "");
  const approved = pick(r, ["approved","ApprovedCapacity(核定收托人數)","核定收托人數"], "");
  const current = pick(r, ["current","CurrentEnrolled(實際收托人數)","實際收托人數"], "");
  const evaluation = pick(r, ["evaluation","Evaluation(評鑑結果)","評鑑結果"], "");

  // 常見欄位：lat/lon or Latitude/Longitude or lat/lng
  const latCandidate = pick(r, ["lat","Lat","Latitude(緯度)","Latitude","緯度","LAT","lng"], "");
  const lonCandidate = pick(r, ["lon","Lon","Longitude(經度)","Longitude","經度","LON","lng","Longitude"], "");

  let lat = null, lon = null;
  // 如果同一列有 lat/lon 或 Latitude/Longitude
  const p1 = normalizeLatLon(pick(r, ["lat","Lat","Latitude","Latitude(緯度)","緯度"], ""), pick(r, ["lon","Lon","Longitude","Longitude(經度)","經度","lng"], ""));
  if (Number.isFinite(p1.lat) && Number.isFinite(p1.lon)) { lat = p1.lat; lon = p1.lon; }

  return { id, name, district, address, phone, approved, current, evaluation, lat, lon };
}

async function fetchText(url) {
  // handle spaces / unicode
  const res = await fetch(encodeURI(url), { cache: "no-store" });
  if (!res.ok) throw new Error(`讀取失敗：${url} (${res.status})`);
  return await res.text();
}

async function loadCsv(url) {
  const text = await fetchText(url);
  const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
  return parsed.data || [];
}

async function loadData() {
  // 1) Try JSON first
  try {
    const res = await fetch(DATA_URL_JSON, { cache: "no-store" });
    if (res.ok) {
      const raw = await res.json();
      const data = (Array.isArray(raw) ? raw : []).map(normalizeRecord);
      return { data, source: "data.json" };
    }
  } catch (e) {}

  // 2) Try join: centers + XY Data
  try {
    const [centersRaw, xyRaw] = await Promise.all([
      loadCsv(DATA_URL_CENTERS_CSV),
      loadCsv(DATA_URL_XY_CSV),
    ]);

    const xyById = new Map();
    for (const r of xyRaw) {
      const id = toInt(pick(r, ["id","ID","序號"], ""));
      if (!id) continue;

      // XY Data：常見欄位 id / Response_Address / lat / lng
      const respAddr = pick(r, ["Response_Address","response_address","標準化地址"], "");
      const a1 = pick(r, ["lat","Lat","Latitude","緯度"], "");
      const a2 = pick(r, ["lng","lon","Lon","Longitude","經度"], "");
      const { lat, lon } = normalizeLatLon(a1, a2);

      xyById.set(id, { respAddr, lat, lon });
    }

    const merged = centersRaw.map(r => {
      const base = normalizeRecord(r);
      if (base.id && xyById.has(base.id)) {
        const xy = xyById.get(base.id);
        // address 以 Response_Address 優先（你也提到會用它做標準化）
        if (xy.respAddr) base.address = xy.respAddr;

        // 若 centers 本身沒有座標，就用 XY 的
        if (!Number.isFinite(base.lat) || !Number.isFinite(base.lon)) {
          base.lat = xy.lat;
          base.lon = xy.lon;
        }
      }
      return base;
    });

    return { data: merged, source: "centers+xy csv" };
  } catch (e) {
    // continue
  }

  // 3) Fallback to single CSV
  try {
    const raw = await loadCsv(DATA_URL_CSV_FALLBACK);
    const data = raw.map(normalizeRecord);
    return { data, source: "data.csv" };
  } catch (e) {
    throw new Error("找不到資料檔：請放 data.json（或 臺北市準公共化托嬰中心.csv + XY Data.csv，或 data.csv）在同一個資料夾。");
  }
}

// Map
const map = L.map("map").setView([25.0330, 121.5654], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

// Marker layer (cluster)
const cluster = L.markerClusterGroup();
map.addLayer(cluster);

// User location marker
let userLoc = null; // {lat, lon}
let userMarker = null;

// Keep marker refs so list click can focus/open popup
const markerByKey = new Map();

function recKey(r) {
  return `${r.id ?? ""}|${r.name}|${r.address}|${r.lat}|${r.lon}`;
}

function gmapsSearchUrl(r) {
  return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.lat + "," + r.lon)}`;
}
function gmapsDirUrl(r) {
  // origin 留空會用當前位置（手機通常更準）
  return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(r.lat + "," + r.lon)}`;
}

function popupHtml(r) {
  const distLine = (userLoc && Number.isFinite(r._distKm))
    ? `<div style="margin-top:6px;font-size:12px"><b>距離：</b>${r._distKm.toFixed(2)} km</div>` : "";

  return `
    <div style="font-family:system-ui,-apple-system,'Noto Sans TC','PingFang TC','Microsoft JhengHei',sans-serif;line-height:1.55">
      <div style="font-weight:700;margin-bottom:6px">${escapeHtml(r.name)}</div>
      <div>行政區：${escapeHtml(r.district)}</div>
      <div>地址：${escapeHtml(r.address)}</div>
      <div>電話：${escapeHtml(r.phone)}</div>
      <div>核定/實際收托：${escapeHtml(String(r.approved))} / ${escapeHtml(String(r.current))}</div>
      <div>評鑑：${escapeHtml(r.evaluation)}</div>
      ${distLine}
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <a href="${gmapsSearchUrl(r)}" target="_blank" rel="noopener">在 Google 地圖開啟</a>
        <a href="${gmapsDirUrl(r)}" target="_blank" rel="noopener">導航到此</a>
      </div>
      <div style="margin-top:6px;color:#64748b;font-size:12px">
        座標：${r.lat.toFixed(6)}, ${r.lon.toFixed(6)}
      </div>
    </div>
  `;
}

let ALL = [];        // all normalized records (may include missing coords)
let PLOTTABLE = [];  // records with lat/lon
let FILTERED = [];   // filtered, plottable

function match(r, q, d, e) {
  if (d && r.district !== d) return false;
  if (e && r.evaluation !== e) return false;
  if (!q) return true;
  const t = `${r.name} ${r.address} ${r.phone}`.toLowerCase();
  return t.includes(q.toLowerCase());
}

function haversineKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2) ** 2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function withDistance(records) {
  if (!userLoc) return records.map(r => ({...r, _distKm: null}));
  return records.map(r => ({...r, _distKm: haversineKm(userLoc.lat, userLoc.lon, r.lat, r.lon)}));
}

function rebuildMarkers(records) {
  cluster.clearLayers();
  markerByKey.clear();

  for (const r of records) {
    const m = L.marker([r.lat, r.lon]).bindPopup(popupHtml(r));
    cluster.addLayer(m);
    markerByKey.set(recKey(r), m);
  }
}

function renderList(records) {
  els.list.innerHTML = "";
  const limit = 400;
  const show = records.slice(0, limit);

  for (const r of show) {
    const div = document.createElement("div");
    div.className = "row";

    const dist = (userLoc && Number.isFinite(r._distKm))
      ? `<div class="meta dist">距離：${r._distKm.toFixed(2)} km</div>` : "";

    div.innerHTML = `
      <div class="name">${escapeHtml(r.name)}</div>
      <div class="meta">行政區：${escapeHtml(r.district)}｜評鑑：${escapeHtml(r.evaluation)}</div>
      ${dist}
      <div class="meta">${escapeHtml(r.address)}</div>
      <div class="meta">${escapeHtml(r.phone)}</div>
    `;
    div.addEventListener("click", () => {
      const key = recKey(r);
      const m = markerByKey.get(key);
      if (m) {
        map.setView([r.lat, r.lon], 16, { animate: true });
        m.openPopup();
      }
    });
    els.list.appendChild(div);
  }

  if (records.length > limit) {
    const hint = document.createElement("div");
    hint.className = "hint";
    hint.style.marginTop = "8px";
    hint.textContent = `結果超過 ${limit} 筆，清單只顯示前 ${limit} 筆；請再加篩選條件。`;
    els.list.appendChild(hint);
  }
}

function renderChips(totalPlottable, missingCoords, filteredCount) {
  const q = els.q.value.trim();
  const d = els.district.value;
  const e = els.evaluation.value;
  const radius = els.radius.value;

  const locChip = userLoc ? `<span class="chip">已定位</span>` : "";

  els.chips.innerHTML = `
    <span class="chip">顯示：${filteredCount} / ${totalPlottable}</span>
    <span class="chip">無座標：${missingCoords}</span>
    ${locChip}
    ${radius ? `<span class="chip">距離：${escapeHtml(radius)} km 內</span>` : ""}
    ${d ? `<span class="chip">行政區：${escapeHtml(d)}</span>` : ""}
    ${e ? `<span class="chip">評鑑：${escapeHtml(e)}</span>` : ""}
    ${q ? `<span class="chip">關鍵字：${escapeHtml(q)}</span>` : ""}
  `;
}

function sortRecords(records) {
  const mode = els.sort.value;
  const arr = [...records];

  if (mode === "distance" && userLoc) {
    arr.sort((a,b) => (a._distKm ?? 1e9) - (b._distKm ?? 1e9));
    return arr;
  }
  if (mode === "district") {
    arr.sort((a,b) => (a.district || "").localeCompare(b.district || "", "zh-Hant") || (a.name || "").localeCompare(b.name || "", "zh-Hant"));
    return arr;
  }
  // default name
  arr.sort((a,b) => (a.name || "").localeCompare(b.name || "", "zh-Hant"));
  return arr;
}

function applyFilters() {
  const q = els.q.value.trim();
  const d = els.district.value;
  const e = els.evaluation.value;
  const radiusKm = toFloat(els.radius.value);

  let out = PLOTTABLE.filter(r => match(r, q, d, e));
  out = withDistance(out);

  if (userLoc && Number.isFinite(radiusKm)) {
    out = out.filter(r => Number.isFinite(r._distKm) && r._distKm <= radiusKm);
  }

  out = sortRecords(out);

  FILTERED = out;
  rebuildMarkers(FILTERED);
  renderList(FILTERED);

  // If only one result, zoom to it
  if (FILTERED.length === 1) {
    const r = FILTERED[0];
    map.setView([r.lat, r.lon], 16, { animate: true });
    const m = markerByKey.get(recKey(r));
    if (m) m.openPopup();
  }

  renderChips(PLOTTABLE.length, ALL.length - PLOTTABLE.length, FILTERED.length);
}

function fillSelectOptions() {
  // reset
  els.district.innerHTML = '<option value="">全部行政區</option>';
  els.evaluation.innerHTML = '<option value="">全部評鑑</option>';

  const districts = uniq(PLOTTABLE.map(x => x.district)).sort();
  const evals = uniq(PLOTTABLE.map(x => x.evaluation)).sort();

  for (const d of districts) {
    const opt = document.createElement("option");
    opt.value = d; opt.textContent = d;
    els.district.appendChild(opt);
  }
  for (const ev of evals) {
    const opt = document.createElement("option");
    opt.value = ev; opt.textContent = ev;
    els.evaluation.appendChild(opt);
  }
}

function downloadFiltered() {
  const blob = new Blob([JSON.stringify(FILTERED, null, 2)], { type: "application/json;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "filtered.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function setUserLocation(lat, lon) {
  userLoc = { lat, lon };

  if (userMarker) userMarker.remove();
  userMarker = L.circleMarker([lat, lon], { radius: 8, weight: 2, fillOpacity: 0.25 });
  userMarker.addTo(map).bindPopup("你目前的位置").openPopup();

  els.clearLocate.disabled = false;
  els.sort.querySelector('option[value="distance"]').disabled = false;
  // 若目前不是 distance，保持；但你可以手動切換
  applyFilters();
}

function clearUserLocation() {
  userLoc = null;
  if (userMarker) { userMarker.remove(); userMarker = null; }
  els.clearLocate.disabled = true;
  els.sort.querySelector('option[value="distance"]').disabled = true;
  if (els.sort.value === "distance") els.sort.value = "name";
  els.radius.value = "";
  applyFilters();
}

function locateMe() {
  if (!navigator.geolocation) {
    alert("瀏覽器不支援定位功能。");
    return;
  }
  els.locate.disabled = true;
  els.locate.textContent = "定位中…";
  navigator.geolocation.getCurrentPosition(
    pos => {
      els.locate.disabled = false;
      els.locate.textContent = "定位我（附近排序/篩選）";
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      setUserLocation(lat, lon);
      map.setView([lat, lon], 14, { animate: true });
    },
    err => {
      els.locate.disabled = false;
      els.locate.textContent = "定位我（附近排序/篩選）";
      alert("定位失敗：請確認瀏覽器已允許位置權限。");
      console.warn(err);
    },
    { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
  );
}

els.q.addEventListener("input", applyFilters);
els.district.addEventListener("change", applyFilters);
els.evaluation.addEventListener("change", applyFilters);
els.radius.addEventListener("change", applyFilters);
els.sort.addEventListener("change", applyFilters);
els.download.addEventListener("click", downloadFiltered);
els.locate.addEventListener("click", locateMe);
els.clearLocate.addEventListener("click", clearUserLocation);

// Boot
(async function init() {
  try {
    setStatus("讀取資料中…");
    const { data, source } = await loadData();

    ALL = data;
    PLOTTABLE = data.filter(r => Number.isFinite(r.lat) && Number.isFinite(r.lon));

    if (PLOTTABLE.length === 0) {
      setStatus("讀到資料，但沒有可用的緯度/經度（lat/lon）。請確認 CSV/JSON 已有座標。");
      return;
    }

    fillSelectOptions();
    applyFilters();

    // Fit bounds to all points
    const latlngs = PLOTTABLE.map(r => [r.lat, r.lon]);
    const bounds = L.latLngBounds(latlngs);
    map.fitBounds(bounds.pad(0.12));

    setStatus(`完成：載入 ${ALL.length} 筆（可標點 ${PLOTTABLE.length} 筆）。來源：${source}`);
  } catch (e) {
    console.error(e);
    setStatus(String(e.message || e));
  }
})();
</script>
</body>
</html>
